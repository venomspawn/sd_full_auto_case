# Статусная модель заявки

Модель заявки на услугу социальной защиты, при оказании которой передача пакета
документов и выдача результат осуществляется в электронном виде.

*  `smev_sending` (отправка заявки в СМЭВ);
*  `error` (ошибка при отправке заявки в СМЭВ);
*  `packaging` (формирование пакета документов);
*  `pending` (ожидание отправки в ведомство);
*  `processing` (обработка заявки в ведомстве);
*  `issuance` (выдача результата заявки);
*  `rejecting` (возврат результата заявки в ведомство);
*  `closed` (заявка закрыта).

Статус заявки `smev_sending` является изначальным и устанавливается
обработчиком `on_case_creation` непосредственно после создания записи заявки.

# Жизненный цикл заявки

Жизненный цикл заявки на услугу социальной защиты с полностью электронным
документооборотом и выдачей результата в электронном виде можно описать
следующим графом переходов, где вершины графа — это названия состояний,
приведённые выше, или отсутствие состояний (сразу после создания записи
заявки), а метки дуг — это вызовы функций модуля с учётом условий на атрибуты и
запросы, которые созданы в рамках заявки.

```
                         +-----------------------------------+
                         |     +-------------------------+   |
                         |     |             +-----------#---#---+
                         |     |             |     B1    |   |   |
                         |     |             |   +----+  |   |   |
                         |     |             |   |    |  |   |   |
           +-+   A   +--------------+  B1  +-------+  |  |   |   |
           | |------>| smev_sending |----->| error |<-+  |   |   |
           +-+       +--------------+      +-------+     |   |   |
                            |                |   |       |   |   |
                            | B2             | B2| B3    | B3| B4| B4
                            |                |   |       |   |   |
                            V                |   |       |   |   |
                      +-----------+          |   |       |   |   |
                      | packaging |<---------+   |       |   |   |
                      +-----------+              |       |   |   |
                         ^     |                 |       |   |   |
                      C2 |     | C1              |       |   |   |
                         |     V                 V       |   |   |
                       +---------+    C6     +--------+  |   |   |
    +------------------| pending |---------->| closed |<-+   |   |
    |       +--------->|         |           +--------+      |   |
    |       |          +---------+               ^           |   |
    |       |               |                    |           |   |
    | C4    | C5            | C3                 | C9        |   |
    |       |               V                    |           |   |
    |       |        +------------+   C7    +----------+     |   |
    |       |        | processing |-------->| issuance |<----+   |
    |       |        +------------+         +----------+         |
    V       |                                 |      ^           |
  +-----------+                       C8      |      |           |
  | rejecting |<------------------------------+      +-----------+
  +-----------+
```

Метки дуг обозначают следующее:

*   `A` — вызов функции `on_case_creation` для записи заявки;
*   `B1` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на услугу социальной
        защиты;
    -   значение поля `format` этого ассоциативного массива равно `EXCEPTION`;
    -   в рамках заявки создано запросов, на которые вернулся ответ с ошибкой,
        в количестве, которое не больше значения константы
        `SDFullAutoShortCase::Request::Repeat::MAX_EXCEPTIONS_COUNT`;
*   `B2` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на услугу социальной
        защиты;
    -   значение поля `format` этого ассоциативного массива равно `EXCEPTION`;
    -   в рамках заявки создано запросов, на которые вернулся ответ с ошибкой,
        в количестве, которое больше значения константы
        `SDFullAutoShortCase::Request::Repeat::MAX_EXCEPTIONS_COUNT`;
*   `B3` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на услугу социальной
        защиты;
    -   значение поля `format` этого ассоциативного массива равно `REJECTION`
        или `RESPONSE`;
    -   атрибут `issue_method` отсутствует или его значение не равно `mfc`;
*   `B4` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на услугу социальной
        защиты;
    -   значение поля `format` этого ассоциативного массива равно `REJECTION`
        или `RESPONSE`;
    -   атрибут `issue_method` присутствует и его значение равно `mfc`;
*   `C1` — вызов функции `change_status_to` для записи заявки и строки
    `pending`;
*   `C2` — вызов функции `change_status_to` для записи заявки и строки
    `packaging` при условии, что атрибут `added_to_rejecting_at` заявки
    отсутствует или его значение пусто;
*   `C3` — вызов функции `change_status_to` для записи заявки и строки
    `processing` при одновременном выполнении следующих условий:
    -   атрибут `issue_location_type` отсутствует или его значение не равно
        `institution`;
    -   атрибут `added_to_rejecting_at` отсутствует или его значение пусто;
*   `C4` — вызов функции `change_status_to` для записи заявки и строки
    `rejecting` при условии, что атрибут `added_to_rejecting_at` заявки
    присутствует и его значение непусто;
*   `C5` — вызов функции `change_status_to` для записи заявки и строки
    `pending`;
*   `C6` — вызов функции `change_status_to` для записи заявки и строки
    `processing`, если выполняется хотя бы одно из следующих условий:
    -   атрибут `issue_location_type` присутствует и его значение равно
        `institution`;
    -   атрибут `added_to_rejecting_at` присутствует и его значение непусто;
*   `C7` — вызов функции `change_status_to` для записи заявки и строки
    `issuance`;
*   `C8` — вызов функции `change_status_to` для записи заявки и строки
    `rejecting` при одновременном условии следующих условий:
    -   атрибут `rejecting_expected_at` присутствует, его значение начинается с
        даты, записанной в формате ISO 8601, и эта дата строго меньше текущей
        даты;
    -   атрибут `close_on_reject` отсутствует или его значение не равно `+`;
*   `C9` — вызов функции `change_status_to` для записи заявки и строки `closed`
    при выполнении хотя бы одного из следующих условий:
    -   атрибут `rejecting_expected_at` присутствует, его значение начинается с
        даты, записанной в формате ISO 8601, и эта дата больше текущей даты или
        равна ей;
    -   атрибут `rejecting_expected_at` присутствует, но его значение не
        начинается с даты, записанной в формате ISO 8601;
    -   атрибут `rejecting_expected_at` присутствует, но его значение пусто;
    -   атрибут `rejecting_expected_at` отсутствует;
    -   атрибут `close_on_reject` присутствует и его значение равно `+`.

Таким образом, жизненный цикл заявки на услугу социальной защиты с полностью
электронным документооборотом и выдачей результата в электронном виде можно
описать следующим образом:
*   сразу после создания записи заявки создаётся запрос в СМЭВ, который
    повторяется, пока повторов не станет слишком много;
*   если из СМЭВ придёт ответ о том, что заявка рассмотрена или отвергнута,
    заявка отправляется на выдачу;
*   если из СМЭВ так и не пришло ответа о том, что заявка рассмотрена или
    отвергнута, заявка переходит на жизненный цикл заявки на
    неавтоматизированную услугу.
